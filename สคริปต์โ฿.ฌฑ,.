--[[
    ROBLOX MUSIC VIEWER V12 - PREVIEW BUTTON ADDED
    Language: Thai (‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢)
    Features: 
    - Smart Sound Scoring (‡πÅ‡∏¢‡∏Å‡πÅ‡∏¢‡∏∞‡πÄ‡∏û‡∏•‡∏á vs ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏≠‡∏ü‡πÄ‡∏ü‡∏Å‡∏ï‡πå)
    - Enhanced Search (Enter Key + Smart Match)
    - Preview Button (Listen for 1 min)
    - Auto UI Parenting (CoreGui / PlayerGui)
    - Universal Clipboard Support
    - Draggable Toggle & Main UI
    - 100% Real Fetch logic
]]

local Players = game:GetService("Players")
local MarketplaceService = game:GetService("MarketplaceService")
local UserInputService = game:GetService("UserInputService")
local CoreGui = game:GetService("CoreGui")
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")

-- --- ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ UI Parent (‡∏Å‡∏±‡∏ô Error) ---
local function getUIParent()
    local success, result = pcall(function()
        return CoreGui
    end)
    if success and result then
        return result
    end
    return Players.LocalPlayer:WaitForChild("PlayerGui")
end

local ParentTarget = getUIParent()

-- ‡∏•‡∏ö UI ‡πÄ‡∏Å‡πà‡∏≤‡∏≠‡∏≠‡∏Å
if ParentTarget:FindFirstChild("MusicViewerUI") then
    ParentTarget.MusicViewerUI:Destroy()
end

-- --- ‡∏™‡∏£‡πâ‡∏≤‡∏á GUI ‡∏´‡∏•‡∏±‡∏Å (MAIN GUI) ---
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "MusicViewerUI"
ScreenGui.Parent = ParentTarget
ScreenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
ScreenGui.ResetOnSpawn = false -- ‡∏Å‡∏±‡∏ô UI ‡∏´‡∏≤‡∏¢‡πÄ‡∏ß‡∏•‡∏≤‡∏ï‡∏≤‡∏¢ (‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏π‡πà PlayerGui)

-- ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
local currentTargetPlayer = nil
local copyConnection = nil
local copyNameConnection = nil
local previewConnection = nil
local previewSound = Instance.new("Sound") -- ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á
previewSound.Name = "MusicPreviewSound"
previewSound.Volume = 1
previewSound.Parent = ScreenGui

-- ==========================================
-- 1. ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏õ‡∏¥‡∏î-‡∏õ‡∏¥‡∏î (TOGGLE BUTTON)
-- ==========================================
local ToggleFrame = Instance.new("Frame")
ToggleFrame.Name = "ToggleFrame"
ToggleFrame.Parent = ScreenGui
ToggleFrame.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
ToggleFrame.Position = UDim2.new(0.02, 0, 0.2, 0)
ToggleFrame.Size = UDim2.new(0, 60, 0, 60)
ToggleFrame.BorderSizePixel = 0
ToggleFrame.Active = true

local ToggleCorner = Instance.new("UICorner")
ToggleCorner.CornerRadius = UDim.new(0, 16)
ToggleCorner.Parent = ToggleFrame

local ToggleStroke = Instance.new("UIStroke")
ToggleStroke.Parent = ToggleFrame
ToggleStroke.Color = Color3.fromRGB(100, 150, 255)
ToggleStroke.Thickness = 2
ToggleStroke.Transparency = 0.5

local ToggleBtn = Instance.new("TextButton")
ToggleBtn.Parent = ToggleFrame
ToggleBtn.BackgroundTransparency = 1
ToggleBtn.Size = UDim2.new(1, 0, 1, 0)
ToggleBtn.Font = Enum.Font.GothamBold
ToggleBtn.Text = "üéµ"
ToggleBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
ToggleBtn.TextSize = 32

local function makeDraggable(frame)
    local dragging, dragInput, dragStart, startPos
    frame.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = true
            dragStart = input.Position
            startPos = frame.Position
            input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then dragging = false end
            end)
        end
    end)
    frame.InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement then dragInput = input end
    end)
    UserInputService.InputChanged:Connect(function(input)
        if input == dragInput and dragging then
            local delta = input.Position - dragStart
            frame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
        end
    end)
end
makeDraggable(ToggleFrame)

-- ==========================================
-- 2. ‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏´‡∏•‡∏±‡∏Å (MAIN WINDOW)
-- ==========================================
local MainFrame = Instance.new("Frame")
MainFrame.Name = "MainFrame"
MainFrame.Parent = ScreenGui
MainFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 35)
MainFrame.BorderSizePixel = 0
MainFrame.Position = UDim2.new(0.5, -300, 0.5, -200)
MainFrame.Size = UDim2.new(0, 600, 0, 440) -- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏´‡∏°‡πà
MainFrame.Visible = true

local MainCorner = Instance.new("UICorner")
MainCorner.CornerRadius = UDim.new(0, 10)
MainCorner.Parent = MainFrame

local MainStroke = Instance.new("UIStroke")
MainStroke.Parent = MainFrame
MainStroke.Color = Color3.fromRGB(60, 60, 60)
MainStroke.Thickness = 2

makeDraggable(MainFrame)

ToggleBtn.MouseButton1Click:Connect(function()
    MainFrame.Visible = not MainFrame.Visible
end)

-- ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ (Title Bar)
local TitleBar = Instance.new("Frame")
TitleBar.Parent = MainFrame
TitleBar.BackgroundColor3 = Color3.fromRGB(40, 40, 45)
TitleBar.Size = UDim2.new(1, 0, 0, 50)
local TitleCorner = Instance.new("UICorner")
TitleCorner.CornerRadius = UDim.new(0, 10)
TitleCorner.Parent = TitleBar

local TitleLabel = Instance.new("TextLabel")
TitleLabel.Parent = TitleBar
TitleLabel.BackgroundTransparency = 1
TitleLabel.Position = UDim2.new(0, 15, 0, 0)
TitleLabel.Size = UDim2.new(0, 300, 1, 0)
TitleLabel.Font = Enum.Font.GothamBold
TitleLabel.Text = "üéµ Music Fetcher Ultimate"
TitleLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
TitleLabel.TextSize = 22
TitleLabel.TextXAlignment = Enum.TextXAlignment.Left

local CloseButton = Instance.new("TextButton")
CloseButton.Parent = TitleBar
CloseButton.BackgroundColor3 = Color3.fromRGB(255, 80, 80)
CloseButton.Position = UDim2.new(1, -45, 0.5, -15)
CloseButton.Size = UDim2.new(0, 30, 0, 30)
CloseButton.Font = Enum.Font.GothamBold
CloseButton.Text = "_"
CloseButton.TextColor3 = Color3.fromRGB(255, 255, 255)
CloseButton.TextSize = 18
local CloseCorner = Instance.new("UICorner")
CloseCorner.CornerRadius = UDim.new(0, 6)
CloseCorner.Parent = CloseButton

CloseButton.MouseButton1Click:Connect(function()
    MainFrame.Visible = false
    previewSound:Stop() -- ‡∏´‡∏¢‡∏∏‡∏î‡πÄ‡∏û‡∏•‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏õ‡∏¥‡∏î
end)

-- --- ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô (Player List) ---
local PlayerListFrame = Instance.new("ScrollingFrame")
PlayerListFrame.Parent = MainFrame
PlayerListFrame.Active = true
PlayerListFrame.BackgroundColor3 = Color3.fromRGB(20, 20, 25)
PlayerListFrame.BorderSizePixel = 0
PlayerListFrame.Position = UDim2.new(0, 15, 0, 65)
PlayerListFrame.Size = UDim2.new(0, 180, 0, 360) -- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á
PlayerListFrame.ScrollBarThickness = 6

local UIListLayout = Instance.new("UIListLayout")
UIListLayout.Parent = PlayerListFrame
UIListLayout.SortOrder = Enum.SortOrder.LayoutOrder
UIListLayout.Padding = UDim.new(0, 6)

local PlayerListPadding = Instance.new("UIPadding")
PlayerListPadding.Parent = PlayerListFrame
PlayerListPadding.PaddingTop = UDim.new(0, 5)
PlayerListPadding.PaddingLeft = UDim.new(0, 5)

-- --- ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Info Panel) ---
local InfoFrame = Instance.new("Frame")
InfoFrame.Parent = MainFrame
InfoFrame.BackgroundTransparency = 1
InfoFrame.Position = UDim2.new(0, 210, 0, 65)
InfoFrame.Size = UDim2.new(0, 375, 0, 360) -- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á

-- ‡∏ä‡πà‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
local SearchInput = Instance.new("TextBox")
SearchInput.Parent = InfoFrame
SearchInput.BackgroundColor3 = Color3.fromRGB(45, 45, 50)
SearchInput.BorderSizePixel = 0
SearchInput.Size = UDim2.new(0.72, 0, 0, 40)
SearchInput.Font = Enum.Font.Gotham
SearchInput.PlaceholderText = "‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πÅ‡∏Å‡∏ô..."
SearchInput.Text = ""
SearchInput.TextColor3 = Color3.fromRGB(255, 255, 255)
SearchInput.TextSize = 16
local SearchCorner = Instance.new("UICorner")
SearchCorner.CornerRadius = UDim.new(0, 8)
SearchCorner.Parent = SearchInput

-- ‡∏õ‡∏∏‡πà‡∏°‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
local SearchBtn = Instance.new("TextButton")
SearchBtn.Parent = InfoFrame
SearchBtn.BackgroundColor3 = Color3.fromRGB(80, 120, 255)
SearchBtn.Position = UDim2.new(0.75, 0, 0, 0)
SearchBtn.Size = UDim2.new(0.25, 0, 0, 40)
SearchBtn.Font = Enum.Font.GothamBold
SearchBtn.Text = "‡∏´‡∏≤"
SearchBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
SearchBtn.TextSize = 16
local BtnCorner = Instance.new("UICorner")
BtnCorner.CornerRadius = UDim.new(0, 8)
BtnCorner.Parent = SearchBtn

-- ‡∏Å‡∏£‡∏≠‡∏ö‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
local DetailsFrame = Instance.new("Frame")
DetailsFrame.Parent = InfoFrame
DetailsFrame.BackgroundColor3 = Color3.fromRGB(25, 25, 30)
DetailsFrame.Position = UDim2.new(0, 0, 0, 55)
DetailsFrame.Size = UDim2.new(1, 0, 0, 305) -- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏´‡∏°‡πà
local DetailsCorner = Instance.new("UICorner")
DetailsCorner.CornerRadius = UDim.new(0, 8)
DetailsCorner.Parent = DetailsFrame

-- ‡∏£‡∏π‡∏õ‡∏õ‡∏Å‡πÄ‡∏û‡∏•‡∏á
local CoverImage = Instance.new("ImageLabel")
CoverImage.Name = "CoverImage"
CoverImage.Parent = DetailsFrame
CoverImage.BackgroundColor3 = Color3.fromRGB(40, 40, 45)
CoverImage.Position = UDim2.new(0, 15, 0, 15)
CoverImage.Size = UDim2.new(0, 110, 0, 110)
CoverImage.Image = "rbxassetid://0"
CoverImage.ScaleType = Enum.ScaleType.Fit
local CoverCorner = Instance.new("UICorner")
CoverCorner.CornerRadius = UDim.new(0, 8)
CoverCorner.Parent = CoverImage

-- Labels
local function createLabel(text, yPos, color, size, isBold)
    local lab = Instance.new("TextLabel")
    lab.Parent = DetailsFrame
    lab.BackgroundTransparency = 1
    lab.Position = UDim2.new(0, 140, 0, yPos)
    lab.Size = UDim2.new(1, -150, 0, 25)
    lab.Font = isBold and Enum.Font.GothamBold or Enum.Font.Gotham
    lab.Text = text
    lab.TextColor3 = color or Color3.fromRGB(220, 220, 220)
    lab.TextSize = size or 16
    lab.TextXAlignment = Enum.TextXAlignment.Left
    lab.TextWrapped = true
    return lab
end

local StatusLabel = createLabel("‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πÅ‡∏Å‡∏ô", 15, Color3.fromRGB(255, 220, 100), 16, true)
local SourceLabel = createLabel("‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ó‡∏µ‡πà‡∏°‡∏≤: -", 40, Color3.fromRGB(150, 150, 150), 14)
local IDLabel = createLabel("UID: -", 65, Color3.fromRGB(255, 255, 255), 18, true)
local NameLabel = createLabel("‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏•‡∏á: -", 90, nil, 16)
local CreatorLabel = createLabel("‡∏•‡∏¥‡∏Ç‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå/‡∏ú‡∏π‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á: -", 115, Color3.fromRGB(100, 200, 255), 14)

-- ‡∏õ‡∏∏‡πà‡∏° Copy UID
local CopyButton = Instance.new("TextButton")
CopyButton.Parent = DetailsFrame
CopyButton.BackgroundColor3 = Color3.fromRGB(46, 204, 113)
CopyButton.Position = UDim2.new(0, 15, 0, 145)
CopyButton.Size = UDim2.new(1, -30, 0, 50)
CopyButton.Font = Enum.Font.GothamBold
CopyButton.Text = "‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å UID ‡πÄ‡∏û‡∏•‡∏á"
CopyButton.TextColor3 = Color3.fromRGB(255, 255, 255)
CopyButton.TextSize = 20
CopyButton.Visible = false
local CopyCorner2 = Instance.new("UICorner")
CopyCorner2.CornerRadius = UDim.new(0, 8)
CopyCorner2.Parent = CopyButton

-- ‡∏õ‡∏∏‡πà‡∏° Copy ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏•‡∏á
local CopyNameBtn = Instance.new("TextButton")
CopyNameBtn.Parent = DetailsFrame
CopyNameBtn.BackgroundColor3 = Color3.fromRGB(60, 60, 70)
CopyNameBtn.Position = UDim2.new(0, 15, 0, 205)
CopyNameBtn.Size = UDim2.new(1, -30, 0, 40)
CopyNameBtn.Font = Enum.Font.Gotham
CopyNameBtn.Text = "‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏•‡∏á"
CopyNameBtn.TextColor3 = Color3.fromRGB(200, 200, 200)
CopyNameBtn.TextSize = 16
CopyNameBtn.Visible = false
local CopyNameCorner = Instance.new("UICorner")
CopyNameCorner.CornerRadius = UDim.new(0, 8)
CopyNameCorner.Parent = CopyNameBtn

-- ‡∏õ‡∏∏‡πà‡∏°‡∏ü‡∏±‡∏á‡πÄ‡∏û‡∏•‡∏á‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á (Preview Button)
local PreviewBtn = Instance.new("TextButton")
PreviewBtn.Parent = DetailsFrame
PreviewBtn.BackgroundColor3 = Color3.fromRGB(155, 89, 182) -- ‡∏™‡∏µ‡∏°‡πà‡∏ß‡∏á
PreviewBtn.Position = UDim2.new(0, 15, 0, 255)
PreviewBtn.Size = UDim2.new(1, -30, 0, 40)
PreviewBtn.Font = Enum.Font.GothamBold
PreviewBtn.Text = "‚ñ∂ ‡∏ü‡∏±‡∏á‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á (1 ‡∏ô‡∏≤‡∏ó‡∏µ)"
PreviewBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
PreviewBtn.TextSize = 16
PreviewBtn.Visible = false
local PreviewCorner = Instance.new("UICorner")
PreviewCorner.CornerRadius = UDim.new(0, 8)
PreviewCorner.Parent = PreviewBtn

-- ==========================================
-- 3. ‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡πÅ‡∏Å‡∏ô‡πÅ‡∏•‡∏∞‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏±‡πâ‡∏ô‡∏™‡∏π‡∏á (SMART LOGIC)
-- ==========================================

local function getAssetInfo(assetId)
    local success, info = pcall(function()
        return MarketplaceService:GetProductInfo(assetId)
    end)
    if success and info then return info end
    return nil
end

local function updateDisplay(soundId, statusMsg, sourceMsg)
    StatusLabel.Text = statusMsg or "‡∏û‡∏ö‡πÄ‡∏û‡∏•‡∏á!"
    SourceLabel.Text = sourceMsg or "‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ó‡∏µ‡πà‡∏°‡∏≤: ‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö"
    
    local cleanId = string.match(soundId, "%d+")
    
    -- ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÅ‡∏•‡∏∞‡∏õ‡∏∏‡πà‡∏°‡∏ü‡∏±‡∏á
    previewSound:Stop()
    PreviewBtn.Text = "‚ñ∂ ‡∏ü‡∏±‡∏á‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á (1 ‡∏ô‡∏≤‡∏ó‡∏µ)"
    PreviewBtn.BackgroundColor3 = Color3.fromRGB(155, 89, 182)
    
    if cleanId then
        IDLabel.Text = "UID: " .. cleanId
        NameLabel.Text = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•..."
        CreatorLabel.Text = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö..."
        
        CoverImage.Image = "rbxassetid://0"
        
        CopyButton.Visible = true
        CopyNameBtn.Visible = true
        PreviewBtn.Visible = true -- ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏ü‡∏±‡∏á
        
        CopyButton.Text = "‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å UID (" .. cleanId .. ")"
        
        task.spawn(function()
            CoverImage.Image = "rbxthumb://type=Asset&id=" .. cleanId .. "&w=150&h=150"
            local info = getAssetInfo(tonumber(cleanId))
            if info then
                NameLabel.Text = string.sub(info.Name, 1, 30)
                CreatorLabel.Text = "‡πÇ‡∏î‡∏¢: " .. (info.Creator.Name or "Unknown")
            else
                NameLabel.Text = "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏•‡∏á"
                CreatorLabel.Text = "‡πÇ‡∏î‡∏¢: -"
            end
        end)
        
        -- ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏õ‡∏∏‡πà‡∏° Copy UID
        if copyConnection then copyConnection:Disconnect() end
        copyConnection = CopyButton.MouseButton1Click:Connect(function()
            local clipFunc = setclipboard or toclipboard or set_clipboard or (syn and syn.write_clipboard)
            
            if clipFunc then
                clipFunc(tostring(cleanId))
                CopyButton.Text = "‚úÖ ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!"
                CopyButton.BackgroundColor3 = Color3.fromRGB(39, 174, 96)
                task.wait(1)
                CopyButton.Text = "‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å UID (" .. cleanId .. ")"
                CopyButton.BackgroundColor3 = Color3.fromRGB(46, 204, 113)
            else
                CopyButton.Text = "‚ùå ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö Clipboard"
                warn("Your executor does not support clipboard functions.")
            end
        end)
        
        -- ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏õ‡∏∏‡πà‡∏° Copy ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏•‡∏á
        if copyNameConnection then copyNameConnection:Disconnect() end
        copyNameConnection = CopyNameBtn.MouseButton1Click:Connect(function()
            local clipFunc = setclipboard or toclipboard or set_clipboard or (syn and syn.write_clipboard)
            
            if clipFunc then
                clipFunc(NameLabel.Text)
                CopyNameBtn.Text = "‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß!"
                task.wait(1)
                CopyNameBtn.Text = "‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏•‡∏á"
            end
        end)
        
        -- ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏õ‡∏∏‡πà‡∏°‡∏ü‡∏±‡∏á‡πÄ‡∏û‡∏•‡∏á (Preview)
        if previewConnection then previewConnection:Disconnect() end
        previewConnection = PreviewBtn.MouseButton1Click:Connect(function()
            if previewSound.IsPlaying then
                -- ‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏¢‡∏π‡πà ‡πÉ‡∏´‡πâ‡∏´‡∏¢‡∏∏‡∏î
                previewSound:Stop()
                PreviewBtn.Text = "‚ñ∂ ‡∏ü‡∏±‡∏á‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á (1 ‡∏ô‡∏≤‡∏ó‡∏µ)"
                PreviewBtn.BackgroundColor3 = Color3.fromRGB(155, 89, 182)
            else
                -- ‡∏ñ‡πâ‡∏≤‡∏´‡∏¢‡∏∏‡∏î‡∏≠‡∏¢‡∏π‡πà ‡πÉ‡∏´‡πâ‡πÄ‡∏•‡πà‡∏ô
                previewSound.SoundId = "rbxassetid://" .. cleanId
                previewSound:Play()
                PreviewBtn.Text = "‚èπ ‡∏´‡∏¢‡∏∏‡∏î‡∏ü‡∏±‡∏á"
                PreviewBtn.BackgroundColor3 = Color3.fromRGB(231, 76, 60) -- ‡∏™‡∏µ‡πÅ‡∏î‡∏á
                
                -- ‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏´‡∏¢‡∏∏‡∏î‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏£‡∏ö 60 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
                task.delay(60, function()
                    if previewSound.IsPlaying and previewSound.SoundId == "rbxassetid://" .. cleanId then
                        previewSound:Stop()
                        PreviewBtn.Text = "‚ñ∂ ‡∏ü‡∏±‡∏á‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á (1 ‡∏ô‡∏≤‡∏ó‡∏µ)"
                        PreviewBtn.BackgroundColor3 = Color3.fromRGB(155, 89, 182)
                    end
                end)
            end
        end)
        
    else
        IDLabel.Text = "‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏û‡∏•‡∏á"
        NameLabel.Text = "-"
        CreatorLabel.Text = "-"
        CoverImage.Image = ""
        CopyButton.Visible = false
        CopyNameBtn.Visible = false
        PreviewBtn.Visible = false -- ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏ü‡∏±‡∏á‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠
    end
end

-- --- SMART FINDER: ‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á ---
-- ‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡πÑ‡∏õ‡πÇ‡∏î‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏¢‡∏ô‡∏ï‡πå/‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏î‡∏¥‡∏ô/‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏≠‡∏ü‡πÄ‡∏ü‡∏Å‡∏ï‡πå
local function calculateSoundScore(sound)
    local score = 0
    
    -- 1. ‡∏ñ‡πâ‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏¢‡∏π‡πà ‡πÄ‡∏≠‡∏≤‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÑ‡∏õ‡πÄ‡∏•‡∏¢
    if sound.Playing then score = score + 50 end
    
    -- 2. ‡∏ñ‡πâ‡∏≤‡πÄ‡∏û‡∏•‡∏á‡∏¢‡∏≤‡∏ß‡∏Å‡∏ß‡πà‡∏≤ 10 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ ‡∏ô‡πà‡∏≤‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏û‡∏•‡∏á (‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏õ‡∏∑‡∏ô/‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏¢‡∏ô‡∏ï‡πå‡∏°‡∏±‡∏Å‡∏à‡∏∞‡∏™‡∏±‡πâ‡∏ô‡πÅ‡∏•‡πâ‡∏ß Loop)
    if sound.TimeLength > 10 then score = score + 30 end
    
    -- 3. ‡∏î‡∏π‡∏ä‡∏∑‡πà‡∏≠ Sound
    local name = sound.Name:lower()
    if name:find("music") or name:find("song") or name:find("radio") then
        score = score + 20
    elseif name:find("engine") or name:find("wind") or name:find("tire") or name:find("walk") then
        score = score - 50 -- ‡∏´‡∏±‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏û‡∏ß‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏£‡∏ñ/‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏î‡∏¥‡∏ô
    end
    
    -- 4. ‡∏î‡∏π Parent (‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô Boombox ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà)
    local parentName = sound.Parent.Name:lower()
    if parentName:find("boombox") or parentName:find("radio") then
        score = score + 20
    end
    
    return score
end

local function findSoundRecursive(parent)
    local bestSoundId = nil
    local maxScore = -100 -- ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ï‡πà‡∏≥‡πÜ
    
    local success, descendants = pcall(function()
        return parent:GetDescendants()
    end)
    
    if not success or not descendants then return nil end

    for _, desc in pairs(descendants) do
        if desc:IsA("Sound") and desc.SoundId ~= "" then
            -- ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÉ‡∏ô ID
            if string.match(desc.SoundId, "%d+") then
                local score = calculateSoundScore(desc)
                
                -- ‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡∏ï‡∏±‡∏ß‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏¢‡πÄ‡∏à‡∏≠ ‡πÉ‡∏´‡πâ‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏ô‡∏µ‡πâ‡πÅ‡∏ó‡∏ô
                if score > maxScore then
                    maxScore = score
                    bestSoundId = desc.SoundId
                end
            end
        end
    end
    
    return bestSoundId
end

local function scanPlayer(player)
    currentTargetPlayer = player
    StatusLabel.Text = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πÅ‡∏Å‡∏ô " .. player.Name .. "..."
    StatusLabel.TextColor3 = Color3.fromRGB(255, 220, 100)
    
    local foundSound = nil
    local sourceName = ""
    
    -- 1. Character Scan
    if player.Character then
        foundSound = findSoundRecursive(player.Character)
        if foundSound then sourceName = "‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£ / ‡∏ß‡∏¥‡∏ó‡∏¢‡∏∏‡∏ó‡∏µ‡πà‡∏ñ‡∏∑‡∏≠" end
    end
    
    -- 2. Vehicle Scan (Smart)
    if not foundSound and player.Character then
        local humanoid = player.Character:FindFirstChild("Humanoid")
        if humanoid and humanoid.SeatPart then
            local seat = humanoid.SeatPart
            local vehicle = seat.Parent
            
            -- ‡∏ß‡∏ô‡∏´‡∏≤ Model ‡∏´‡∏•‡∏±‡∏Å‡∏Ç‡∏≠‡∏á‡∏£‡∏ñ
            while vehicle.Parent and not vehicle.Parent:IsA("Workspace") do
                vehicle = vehicle.Parent
            end
            
            -- ‡∏™‡πÅ‡∏Å‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏Ñ‡∏±‡∏ô‡∏£‡∏ñ
            foundSound = findSoundRecursive(vehicle)
            if foundSound then sourceName = "‡∏¢‡∏≤‡∏ô‡∏û‡∏≤‡∏´‡∏ô‡∏∞ (‡∏£‡∏ñ/‡πÄ‡∏£‡∏∑‡∏≠)" end
        end
    end
    
    -- 3. Backpack Scan
    if not foundSound and player.Backpack then
        foundSound = findSoundRecursive(player.Backpack)
        if foundSound then sourceName = "‡πÉ‡∏ô‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤ (Backpack)" end
    end

    if foundSound then
        updateDisplay(foundSound, "‚úÖ ‡πÄ‡∏à‡∏≠‡πÄ‡∏û‡∏•‡∏á‡πÅ‡∏•‡πâ‡∏ß!", "‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ó‡∏µ‡πà‡∏°‡∏≤: " .. sourceName)
        StatusLabel.TextColor3 = Color3.fromRGB(100, 255, 100)
    else
        StatusLabel.Text = "‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠‡∏≠‡∏¢‡∏π‡πà‡πÑ‡∏≠‡∏î‡∏µ‡πÄ‡∏û‡∏•‡∏á‡∏ô‡∏µ‡πâ"
        StatusLabel.TextColor3 = Color3.fromRGB(255, 80, 80)
        SourceLabel.Text = "‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ó‡∏µ‡πà‡∏°‡∏≤: -"
        updateDisplay("", "‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠‡∏≠‡∏¢‡∏π‡πà‡πÑ‡∏≠‡∏î‡∏µ‡πÄ‡∏û‡∏•‡∏á‡∏ô‡∏µ‡πâ", "-")
    end
end

-- --- ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô ---
local function createPlayerButton(player)
    local btn = Instance.new("TextButton")
    btn.Name = player.Name
    btn.Parent = PlayerListFrame
    btn.BackgroundColor3 = Color3.fromRGB(45, 45, 50)
    btn.Size = UDim2.new(1, -5, 0, 40)
    btn.Font = Enum.Font.Gotham
    btn.Text = "  " .. player.Name
    btn.TextColor3 = Color3.fromRGB(220, 220, 220)
    btn.TextSize = 15
    btn.TextXAlignment = Enum.TextXAlignment.Left
    
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 6)
    corner.Parent = btn
    
    btn.MouseButton1Click:Connect(function()
        for _, child in pairs(PlayerListFrame:GetChildren()) do
            if child:IsA("TextButton") then
                child.BackgroundColor3 = Color3.fromRGB(45, 45, 50)
            end
        end
        btn.BackgroundColor3 = Color3.fromRGB(80, 120, 255)
        scanPlayer(player)
    end)
end

local function refreshList()
    for _, child in pairs(PlayerListFrame:GetChildren()) do
        if child:IsA("TextButton") then child:Destroy() end
    end
    for _, player in pairs(Players:GetPlayers()) do
        createPlayerButton(player)
    end
end

Players.PlayerAdded:Connect(refreshList)
Players.PlayerRemoving:Connect(refreshList)

-- ‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÉ‡∏´‡∏°‡πà (SEARCH LOGIC)
local function performSearch()
    local text = SearchInput.Text:gsub("^%s*(.-)%s*$", "%1") -- ‡∏ï‡∏±‡∏î‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏á
    if text == "" then return end
    
    local searchName = text:lower()
    local foundPlayer = nil
    local players = Players:GetPlayers()
    
    -- 1. ‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠ Username ‡∏ï‡∏£‡∏á‡πÄ‡∏õ‡πä‡∏∞ (Priority ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î)
    for _, p in pairs(players) do
        if p.Name:lower() == searchName then
            foundPlayer = p
            break
        end
    end
    
    -- 2. ‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠ Display Name ‡∏ï‡∏£‡∏á‡πÄ‡∏õ‡πä‡∏∞
    if not foundPlayer then
        for _, p in pairs(players) do
            if p.DisplayName:lower() == searchName then
                foundPlayer = p
                break
            end
        end
    end
    
    -- 3. ‡∏´‡∏≤‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á‡∏ä‡∏∑‡πà‡∏≠ (Partial Match)
    if not foundPlayer then
        for _, p in pairs(players) do
            if p.Name:lower():find(searchName) or p.DisplayName:lower():find(searchName) then
                foundPlayer = p
                break
            end
        end
    end
    
    if foundPlayer then
        -- ‡πÑ‡∏Æ‡πÑ‡∏•‡∏ó‡πå‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠
        for _, child in pairs(PlayerListFrame:GetChildren()) do
            if child:IsA("TextButton") then
                if child.Name == foundPlayer.Name then
                    child.BackgroundColor3 = Color3.fromRGB(80, 120, 255)
                    -- ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô Scrollbar ‡πÑ‡∏õ‡∏´‡∏≤‡∏õ‡∏∏‡πà‡∏° (‡∏ñ‡πâ‡∏≤‡∏ó‡∏≥‡πÑ‡∏î‡πâ) ‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡πá‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ
                else
                    child.BackgroundColor3 = Color3.fromRGB(45, 45, 50)
                end
            end
        end
        
        -- ‡∏™‡πÅ‡∏Å‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
        scanPlayer(foundPlayer)
    else
        StatusLabel.Text = "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô: " .. text
        StatusLabel.TextColor3 = Color3.fromRGB(255, 80, 80)
    end
end

SearchBtn.MouseButton1Click:Connect(performSearch)
SearchInput.FocusLost:Connect(function(enterPressed)
    if enterPressed then
        performSearch()
    end
end)

refreshList()
